<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Print Labels</title>
    <link rel="icon" type="image/svg+xml" th:href="@{/favicon.svg}">
    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">
    <style>
        @media print {
            @page {
                size: auto;
                margin: 0;
            }

            body {
                margin: 0;
                padding: 0;
            }

            .no-print {
                display: none;
            }

            .page-break {
                page-break-after: always;
            }
        }

        /* Default Grid (A4_40) fallback */
        .label-grid {
            display: grid;
            gap: 0;
            padding: 0;
        }

        .label-item {
            border: 1px dashed #ccc;
            padding: 1px;
            text-align: center;
            page-break-inside: avoid;
            background: white;
            overflow: hidden;
        }

        /* A4 - 24 Labels (3x8) */
        .sheet-A4_24 .label-grid {
            grid-template-columns: repeat(3, 1fr);
        }

        /* A4 - 40 Labels (4x10) */
        .sheet-A4_40 .label-grid {
            grid-template-columns: repeat(4, 1fr);
        }

        /* Thermal - 4x6" (100x150mm) */
        .sheet-THERMAL_4x6 {
            width: 100mm;
        }

        .sheet-THERMAL_4x6 .label-grid {
            grid-template-columns: 1fr;
            gap: 0;
            padding: 0;
        }

        .sheet-THERMAL_4x6 .label-item {
            width: 100mm;
            height: 150mm;
            border: none;
            padding: 5mm;
            page-break-after: always;
            display: flex;
            /* Center vertically for thermal */
            flex-direction: column;
            justify-content: center;
        }

        /* Thermal - 2x1" (50x25mm) */
        .sheet-THERMAL_2x1 {
            width: 50mm;
        }

        .sheet-THERMAL_2x1 .label-grid {
            grid-template-columns: 1fr;
            gap: 0;
            padding: 0;
        }

        .sheet-THERMAL_2x1 .label-item {
            width: 50mm;
            height: 25mm;
            border: none;
            /* No border for small thermal */
            padding: 1mm;
            page-break-after: always;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* Adjust font sizes for tiny labels */
        .sheet-THERMAL_2x1 .label-item .qr-img {
            max-width: 14mm;
            max-height: 14mm;
            width: auto;
            height: auto;
        }

        .sheet-THERMAL_2x1 .label-item .fw-bold {
            font-size: 6pt !important;
        }

        .sheet-THERMAL_2x1 .label-item div {
            font-size: 5pt !important;
            line-height: 1.1;
        }

        /* Custom Thermal */
        .sheet-THERMAL_CUSTOM .label-grid {
            grid-template-columns: 1fr;
            gap: 0;
            padding: 0;
        }

        .sheet-THERMAL_CUSTOM .label-item {
            border: none;
            padding: 2mm;
            page-break-after: always;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
    </style>

    <style th:if="${labelSheetSize == 'THERMAL_CUSTOM'}" th:utext="'
        @page {
            size: ' + ${customLabelWidth} + 'mm ' + ${customLabelHeight} + 'mm;
            margin: 0;
        }
        .sheet-THERMAL_CUSTOM {
            width: ' + ${customLabelWidth} + 'mm;
        }
        .sheet-THERMAL_CUSTOM .label-item {
            width: ' + ${customLabelWidth} + 'mm;
            height: ' + ${customLabelHeight} + 'mm;
        }
    '"></style>

</head>

<body th:class="'sheet-' + ${labelSheetSize != null ? labelSheetSize : 'A4_40'}">
    <div class="container-fluid">
        <div class="no-print d-flex justify-content-between align-items-center bg-light p-3 border-bottom mb-4">
            <div>
                <h4 class="mb-0">Batch: <span th:text="${batch.batchCode}"></span></h4>
                <small class="text-muted" th:text="${batch.product.name}"></small>
            </div>
            <div>
                <button onclick="window.print()" class="btn btn-primary"><i
                        class="bi bi-printer-fill me-2"></i>Print</button>
                <a th:href="@{/batches/{id}(id=${batch.id})}" class="btn btn-outline-secondary">Back</a>
            </div>
        </div>

        <div class="label-grid">
            <div th:each="u : ${units}" class="label-item">
                <div class="d-flex align-items-center justify-content-center flex-column h-100 w-100 text-center">
                    <!-- Configurable Company Name -->
                    <div th:if="${companyName != null && !companyName.isEmpty()}" class="fw-bold text-uppercase w-100"
                        style="font-size: 12pt; border-bottom: 2px solid #000; margin-bottom: 0; line-height: 1;"
                        th:text="${companyName}">Mushroom Operations</div>

                    <div th:if="${companyName == null || companyName.isEmpty()}" class="text-danger no-print"
                        style="font-size: 8pt;">
                        <span sec:authorize="hasRole('ADMIN')"><a href="/admin/settings" target="_blank">Set
                                Name</a></span>
                        <span sec:authorize="!hasRole('ADMIN')">Config Name</span>
                    </div>

                    <img th:src="'data:image/png;base64,' + ${qrCodes.get(u.id)}" class="qr-img"
                        style="max-height: 40%; width: auto; margin: 0;" />

                    <div class="fw-bold w-100"
                        style="font-size: 18pt; font-family: monospace; line-height: 0.85; white-space: nowrap; overflow: hidden; text-overflow: clip;"
                        th:text="${u.uuid}">UUID</div>

                    <div class="text-uppercase fw-bold w-100" style="font-size: 12pt; line-height: 0.9;"
                        th:text="${batch.product.name}">PROD</div>

                    <div class="w-100" style="font-size: 12pt; line-height: 0.9; margin-top: 1px;">
                        Pkd: <span th:text="${batch.batchDate}">DATE</span> | Exp: <span
                            th:text="${batch.expiryDate}">DATE</span>
                    </div>

                    <div class="w-100" style="font-size: 10pt; font-style: italic; line-height: 0.9;"
                        th:if="${batch.product.storageInstructions != null}"
                        th:text="${batch.product.storageInstructions}">Storage</div>

                    <div th:if="${batch.product.fssaiLicenseNumber != null && !batch.product.fssaiLicenseNumber.isEmpty()}"
                        class="w-100" style="font-size: 10pt; margin-top: 0; font-weight: bold; line-height: 0.9;"
                        th:text="'FSSAI Lic No: ' + ${batch.product.fssaiLicenseNumber}">FSSAI</div>

                    <div th:if="${batch.product.mrp != null}" class="w-100"
                        style="font-size: 12pt; margin-top: 0; font-weight: bold; line-height: 0.9;"
                        th:text="'MRP: ₹' + ${batch.product.mrp}">MRP: ₹100.00</div>

                    <!-- Configurable Contact -->
                    <div th:if="${contactNumber != null && !contactNumber.isEmpty()}" class="w-100"
                        style="font-size: 10pt; margin-top: 0; font-weight: bold; line-height: 0.9;"
                        th:text="'Contact: ' + ${contactNumber}">Contact</div>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            autoFitLabels();
        });

        // Also run on window load to ensure images are loaded
        window.addEventListener("load", function () {
            autoFitLabels();
        });

        function autoFitLabels() {
            const labels = document.querySelectorAll('.label-item');
            labels.forEach(label => {
                const content = label.querySelector('div'); // The inner d-flex wrapper
                if (content) {
                    // Reset transform to get natural size
                    content.style.transform = 'none';
                    content.style.width = '100%'; // Ensure full width for calc

                    // Get computed styles to check padding
                    const style = window.getComputedStyle(label);
                    const paddingVertical = parseFloat(style.paddingTop) + parseFloat(style.paddingBottom);
                    const paddingHorizontal = parseFloat(style.paddingLeft) + parseFloat(style.paddingRight);

                    // Available space is client size MINUS padding (since clientHeight includes padding)
                    // ...actually clientHeight includes padding. 
                    // But content sits inside padding.
                    // So we want the content box size.
                    const availableHeight = label.clientHeight - paddingVertical;
                    const availableWidth = label.clientWidth - paddingHorizontal;

                    // Use scrollHeight/Width to get full content size
                    const contentHeight = content.scrollHeight;
                    const contentWidth = content.scrollWidth;

                    // Calculate scale factors
                    if (contentHeight > availableHeight || contentWidth > availableWidth) {
                        const scaleH = availableHeight / contentHeight;
                        const scaleW = availableWidth / contentWidth;

                        // Use the smaller scale to fit both dimensions, with a 5% buffer
                        const scale = Math.min(scaleH, scaleW) * 0.95;

                        // Set origin to center so it shrinks into the middle
                        content.style.transformOrigin = 'center center';
                        content.style.transform = `scale(${scale})`;
                    }
                }
            });
        }
    </script>
</body>

</html>